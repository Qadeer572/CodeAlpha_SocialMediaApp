{% extends 'core/base.html' %}

{% block title %}
    Home
{% endblock title %}

{% block body %}
<div class="container mt-5">
    <!-- Tabs: Following | For You -->
    <ul class="nav nav-tabs mb-4" id="feedTabs">
        <li class="nav-item">
            <a class="nav-link active" id="following-tab" href="#following-section" data-bs-toggle="tab">Following</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="foryou-tab" href="#foryou-section" data-bs-toggle="tab">For You</a>
        </li>
    </ul>

    <!-- Posts Container -->
    <div class="d-flex justify-content-center">
        <div style="max-width: 600px; width: 100%">
            <div class="tab-content">
                <!-- Following Posts -->
                <div class="tab-pane fade show active" id="following-section">
                    {% include 'core/post_list.html' with posts=following_posts %}
                </div>

                <!-- For You Posts -->
                <div class="tab-pane fade" id="foryou-section">
                    {% include 'core/post_list.html' with posts=foryou_posts %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
    // Cache CSRF token on page load
    const csrftoken = (function() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith('csrftoken=')) {
                return decodeURIComponent(cookie.substring('csrftoken='.length));
            }
        }
        return '';
    })();

    // Debounce function to limit rapid clicks
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    // Like handler with event delegation
    document.addEventListener('click', function(event) {
        const button = event.target.closest('.like-btn');
        if (!button) return;

        const postId = button.dataset.postId;
        const likeCountSpan = button.querySelector(`#like-count-${postId}`);

        const debouncedLike = debounce(async () => {
            try {
                const response = await fetch('/likePost/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    credentials: 'include',
                    body: JSON.stringify({ id: postId }),
                });

                if (response.ok) {
                    const data = await response.json();
                    likeCountSpan.textContent = data.likes_count;
                    button.classList.toggle('btn-danger', data.liked);
                    button.classList.toggle('btn-outline-danger', !data.liked);
                    button.querySelector('.like-text').textContent = `Like${data.likes_count !== 1 ? 's' : ''}`;
                } else {
                    console.error('Failed to like the post');
                }
            } catch (err) {
                console.error('Error:', err);
            }
        }, 300);

        debouncedLike();
    });
</script>
{% endblock body %}